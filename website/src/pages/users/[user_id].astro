---
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  // Import dynasty and chopped data
  const dynastyData = await import('../../../public/data/user_lineups_dynasty.json');
  const choppedData = await import('../../../public/data/user_lineups_chopped.json');
  
  const dynastyUsers = dynastyData.default?.users || dynastyData.users || [];
  const choppedUsers = choppedData.default?.users || choppedData.users || [];
  
  const paths = [];
  
  // Create paths for dynasty users
  dynastyUsers.forEach(user => {
    paths.push({
      params: { 
        user_id: `dynasty-${user.user_id}` 
      },
      props: { 
        user: user,
        league: 'Dynasty',
        current_week: dynastyData.default?.current_week || dynastyData.current_week || 15
      }
    });
  });
  
  // Create paths for chopped users
  choppedUsers.forEach(user => {
    paths.push({
      params: { 
        user_id: `chopped-${user.user_id}` 
      },
      props: { 
        user: user,
        league: 'Chopped',
        current_week: choppedData.default?.current_week || choppedData.current_week || 15
      }
    });
  });
  
  return paths;
}

const { user, league, current_week } = Astro.props;

// Group players by position
const qbs = user.players.filter(p => p.position === 'QB');
const rbs = user.players.filter(p => p.position === 'RB');
const wrs = user.players.filter(p => p.position === 'WR');
const tes = user.players.filter(p => p.position === 'TE');
const flex = [...rbs, ...wrs, ...tes];
const kickers = user.players.filter(p => p.position === 'K');

// Calculate recommended starters (simple heuristic: highest avg_ppg for current matchup)
function getRecommendedStarters(players, count) {
  return [...players]
    .sort((a, b) => b.avg_ppg - a.avg_ppg)
    .slice(0, count);
}

const recommendedQB = getRecommendedStarters(qbs, 1);
const recommendedRB = getRecommendedStarters(rbs, 2);
const recommendedWR = getRecommendedStarters(wrs, 2);
const recommendedTE = getRecommendedStarters(tes, 1);
const recommendedFlex = getRecommendedStarters(
  flex.filter(p => !recommendedRB.includes(p) && !recommendedWR.includes(p) && !recommendedTE.includes(p)),
  1
);
const recommendedK = getRecommendedStarters(kickers, 1);

const recommendedLineup = [
  ...recommendedQB,
  ...recommendedRB,
  ...recommendedWR,
  ...recommendedTE,
  ...recommendedFlex,
  ...recommendedK
];
---

<BaseLayout title={`${user.user_name} - Week ${current_week} Lineup Advisor`}>
  <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <div class="page-header">
    <a href={league === 'Dynasty' ? '/season-stats-dynasty' : '/season-stats-chopped'} class="back-link">
      ‚Üê Back to {league} Stats
    </a>
    <h1>üèà {user.user_name}'s Lineup</h1>
    <p>Week {current_week} Matchup Advisor - {league} League</p>
  </div>

  <div class="container">
    <!-- Recommended Lineup -->
    <section class="recommended-section">
      <h2>üí° Recommended Starters (Week {current_week})</h2>
      <p class="section-subtitle">Based on season average PPG and matchup difficulty</p>
      
      <div class="recommended-grid">
        {recommendedLineup.map(player => (
          <a href={`/players/${player.player_id}`} class="recommended-card">
            <div class="position-badge {player.position.toLowerCase()}">{player.position}</div>
            <div class="player-info">
              <div class="player-name">{player.player_name}</div>
              <div class="player-team">{player.team} vs {player.opponent}</div>
            </div>
            <div class="player-stats">
              <div class="stat-item">
                <span class="stat-label">Avg</span>
                <span class="stat-value">{player.avg_ppg.toFixed(1)}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Opp</span>
                <span class="stat-value">{player.opp_avg_allowed.toFixed(1)}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Trend</span>
                <span class="stat-value" style={{color: player.trend_dir === '‚ñ≤' ? 'green' : (player.trend_dir === '‚ñº' ? 'red' : 'gray')}}>
                  {player.trend_dir}
                </span>
              </div>
            </div>
          </a>
        ))}
      </div>
    </section>

    <!-- Position Scatter Plots -->
    <section class="charts-section">
      <h2>üìä Matchup Analysis by Position</h2>
      <p class="section-subtitle">Player Average vs Opponent Average Allowed</p>
      
      <div class="charts-grid">
        <div class="chart-card">
          <h3>Quarterbacks</h3>
          <canvas id="qbChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Running Backs</h3>
          <canvas id="rbChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Wide Receivers</h3>
          <canvas id="wrChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Tight Ends</h3>
          <canvas id="teChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Full Roster Tables -->
    <section class="roster-section">
      <h2>üìã Full Roster Stats</h2>
      
      {qbs.length > 0 && (
        <div class="position-table">
          <h3>Quarterbacks</h3>
          <table>
            <thead>
              <tr>
                <th>Player</th>
                <th>Team</th>
                <th>Week {current_week} Opp</th>
                <th>Avg PPG</th>
                <th>Opp Avg</th>
                <th>Matchup Diff</th>
                <th>Trend</th>
                <th>Consistency</th>
              </tr>
            </thead>
            <tbody>
              {qbs.map(player => (
                <tr>
                  <td><a href={`/players/${player.player_id}`}>{player.player_name}</a></td>
                  <td>{player.team}</td>
                  <td>{player.opponent}</td>
                  <td style="font-weight: bold;">{player.avg_ppg.toFixed(1)}</td>
                  <td>{player.opp_avg_allowed.toFixed(1)}</td>
                  <td style={{color: (player.avg_ppg - player.opp_avg_allowed) > 0 ? 'green' : 'red'}}>
                    {(player.avg_ppg - player.opp_avg_allowed) > 0 ? '+' : ''}{(player.avg_ppg - player.opp_avg_allowed).toFixed(1)}
                  </td>
                  <td style={{color: player.trend_dir === '‚ñ≤' ? 'green' : (player.trend_dir === '‚ñº' ? 'red' : 'inherit')}}>
                    {player.trend_dir} {player.trend_pct.toFixed(0)}%
                  </td>
                  <td>{player.consistency.toFixed(2)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {rbs.length > 0 && (
        <div class="position-table">
          <h3>Running Backs</h3>
          <table>
            <thead>
              <tr>
                <th>Player</th>
                <th>Team</th>
                <th>Week {current_week} Opp</th>
                <th>Avg PPG</th>
                <th>Opp Avg</th>
                <th>Matchup Diff</th>
                <th>Trend</th>
                <th>Consistency</th>
              </tr>
            </thead>
            <tbody>
              {rbs.map(player => (
                <tr>
                  <td><a href={`/players/${player.player_id}`}>{player.player_name}</a></td>
                  <td>{player.team}</td>
                  <td>{player.opponent}</td>
                  <td style="font-weight: bold;">{player.avg_ppg.toFixed(1)}</td>
                  <td>{player.opp_avg_allowed.toFixed(1)}</td>
                  <td style={{color: (player.avg_ppg - player.opp_avg_allowed) > 0 ? 'green' : 'red'}}>
                    {(player.avg_ppg - player.opp_avg_allowed) > 0 ? '+' : ''}{(player.avg_ppg - player.opp_avg_allowed).toFixed(1)}
                  </td>
                  <td style={{color: player.trend_dir === '‚ñ≤' ? 'green' : (player.trend_dir === '‚ñº' ? 'red' : 'inherit')}}>
                    {player.trend_dir} {player.trend_pct.toFixed(0)}%
                  </td>
                  <td>{player.consistency.toFixed(2)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {wrs.length > 0 && (
        <div class="position-table">
          <h3>Wide Receivers</h3>
          <table>
            <thead>
              <tr>
                <th>Player</th>
                <th>Team</th>
                <th>Week {current_week} Opp</th>
                <th>Avg PPG</th>
                <th>Opp Avg</th>
                <th>Matchup Diff</th>
                <th>Trend</th>
                <th>Consistency</th>
              </tr>
            </thead>
            <tbody>
              {wrs.map(player => (
                <tr>
                  <td><a href={`/players/${player.player_id}`}>{player.player_name}</a></td>
                  <td>{player.team}</td>
                  <td>{player.opponent}</td>
                  <td style="font-weight: bold;">{player.avg_ppg.toFixed(1)}</td>
                  <td>{player.opp_avg_allowed.toFixed(1)}</td>
                  <td style={{color: (player.avg_ppg - player.opp_avg_allowed) > 0 ? 'green' : 'red'}}>
                    {(player.avg_ppg - player.opp_avg_allowed) > 0 ? '+' : ''}{(player.avg_ppg - player.opp_avg_allowed).toFixed(1)}
                  </td>
                  <td style={{color: player.trend_dir === '‚ñ≤' ? 'green' : (player.trend_dir === '‚ñº' ? 'red' : 'inherit')}}>
                    {player.trend_dir} {player.trend_pct.toFixed(0)}%
                  </td>
                  <td>{player.consistency.toFixed(2)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {tes.length > 0 && (
        <div class="position-table">
          <h3>Tight Ends</h3>
          <table>
            <thead>
              <tr>
                <th>Player</th>
                <th>Team</th>
                <th>Week {current_week} Opp</th>
                <th>Avg PPG</th>
                <th>Opp Avg</th>
                <th>Matchup Diff</th>
                <th>Trend</th>
                <th>Consistency</th>
              </tr>
            </thead>
            <tbody>
              {tes.map(player => (
                <tr>
                  <td><a href={`/players/${player.player_id}`}>{player.player_name}</a></td>
                  <td>{player.team}</td>
                  <td>{player.opponent}</td>
                  <td style="font-weight: bold;">{player.avg_ppg.toFixed(1)}</td>
                  <td>{player.opp_avg_allowed.toFixed(1)}</td>
                  <td style={{color: (player.avg_ppg - player.opp_avg_allowed) > 0 ? 'green' : 'red'}}>
                    {(player.avg_ppg - player.opp_avg_allowed) > 0 ? '+' : ''}{(player.avg_ppg - player.opp_avg_allowed).toFixed(1)}
                  </td>
                  <td style={{color: player.trend_dir === '‚ñ≤' ? 'green' : (player.trend_dir === '‚ñº' ? 'red' : 'inherit')}}>
                    {player.trend_dir} {player.trend_pct.toFixed(0)}%
                  </td>
                  <td>{player.consistency.toFixed(2)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {kickers.length > 0 && (
        <div class="position-table">
          <h3>Kickers</h3>
          <table>
            <thead>
              <tr>
                <th>Player</th>
                <th>Team</th>
                <th>Week {current_week} Opp</th>
                <th>Avg PPG</th>
                <th>Trend</th>
                <th>Consistency</th>
              </tr>
            </thead>
            <tbody>
              {kickers.map(player => (
                <tr>
                  <td><a href={`/players/${player.player_id}`}>{player.player_name}</a></td>
                  <td>{player.team}</td>
                  <td>{player.opponent}</td>
                  <td style="font-weight: bold;">{player.avg_ppg.toFixed(1)}</td>
                  <td style={{color: player.trend_dir === '‚ñ≤' ? 'green' : (player.trend_dir === '‚ñº' ? 'red' : 'inherit')}}>
                    {player.trend_dir} {player.trend_pct.toFixed(0)}%
                  </td>
                  <td>{player.consistency.toFixed(2)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </section>
  </div>

  <script define:vars={{ qbs, rbs, wrs, tes }}>
    function createScatterChart(canvasId, players, positionName) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      const data = players.map(p => ({
        x: p.opp_avg_allowed,
        y: p.avg_ppg,
        player: p.player_name
      }));

      // Calculate max values for axis scaling
      const maxOppAvg = Math.max(...players.map(p => p.opp_avg_allowed), 10);
      const maxPlayerAvg = Math.max(...players.map(p => p.avg_ppg), 10);
      const axisMax = Math.max(maxOppAvg, maxPlayerAvg) * 1.1;

      new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Your Players',
            data: data,
            backgroundColor: 'rgba(102, 126, 234, 0.6)',
            borderColor: '#667eea',
            borderWidth: 2,
            pointRadius: 8,
            pointHoverRadius: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1.2,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const point = context.raw;
                  const diff = point.x - point.y;
                  let matchupText = '';
                  if (diff > 3) {
                    matchupText = 'Favorable Matchup ‚úì';
                  } else if (diff < -3) {
                    matchupText = 'Tough Matchup ‚úó';
                  } else {
                    matchupText = 'Average Matchup';
                  }
                  return [
                    point.player,
                    `Player Avg: ${point.y.toFixed(1)} pts`,
                    `Opp Avg Allowed: ${point.x.toFixed(1)} pts`,
                    matchupText
                  ];
                }
              }
            },
            legend: {
              display: false
            },
            annotation: {
              annotations: {
                diagonal: {
                  type: 'line',
                  xMin: 0,
                  yMin: 0,
                  xMax: axisMax,
                  yMax: axisMax,
                  borderColor: 'rgba(231, 76, 60, 0.5)',
                  borderWidth: 2,
                  borderDash: [5, 5],
                  label: {
                    content: 'Equal Performance Line',
                    enabled: true,
                    position: 'end'
                  }
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Opponent Avg Points Allowed',
                font: { size: 12, weight: 'bold' }
              },
              min: 0,
              max: axisMax,
              ticks: {
                callback: function(value) {
                  return value.toFixed(0);
                }
              }
            },
            y: {
              title: {
                display: true,
                text: 'Player Avg Points Per Game',
                font: { size: 12, weight: 'bold' }
              },
              min: 0,
              max: axisMax,
              ticks: {
                callback: function(value) {
                  return value.toFixed(0);
                }
              }
            }
          }
        }
      });
    }

    // Initialize charts
    if (qbs.length > 0) createScatterChart('qbChart', qbs, 'QB');
    if (rbs.length > 0) createScatterChart('rbChart', rbs, 'RB');
    if (wrs.length > 0) createScatterChart('wrChart', wrs, 'WR');
    if (tes.length > 0) createScatterChart('teChart', tes, 'TE');
  </script>

  <style>
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .page-header {
      text-align: center;
      margin-bottom: 40px;
      padding: 30px 20px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .page-header h1 {
      font-size: 2.5em;
      color: #2d3748;
      margin: 10px 0;
    }

    .page-header p {
      color: #718096;
      font-size: 1.1em;
    }

    .back-link {
      display: inline-block;
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      margin-bottom: 10px;
      transition: all 0.3s;
    }

    .back-link:hover {
      color: #5568d3;
      transform: translateX(-5px);
    }

    .section-subtitle {
      color: #718096;
      margin-top: 5px;
      margin-bottom: 20px;
    }

    /* Recommended Lineup Section */
    .recommended-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .recommended-section h2 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .recommended-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .recommended-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-decoration: none;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .recommended-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .position-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 5px;
      font-size: 0.8em;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.2);
      width: fit-content;
    }

    .player-info {
      flex: 1;
    }

    .player-name {
      font-weight: bold;
      font-size: 1.1em;
    }

    .player-team {
      font-size: 0.9em;
      opacity: 0.9;
      margin-top: 5px;
    }

    .player-stats {
      display: flex;
      gap: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .stat-label {
      font-size: 0.7em;
      opacity: 0.8;
    }

    .stat-value {
      font-weight: bold;
      font-size: 1.1em;
    }

    /* Charts Section */
    .charts-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .charts-section h2 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 30px;
      margin-top: 20px;
    }

    .chart-card {
      background: #f7fafc;
      padding: 20px;
      border-radius: 10px;
    }

    .chart-card h3 {
      color: #2d3748;
      margin-bottom: 15px;
      text-align: center;
    }

    /* Roster Tables */
    .roster-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .roster-section h2 {
      color: #667eea;
      margin-bottom: 30px;
    }

    .position-table {
      margin-bottom: 40px;
    }

    .position-table h3 {
      color: #2d3748;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    thead {
      background: #f7fafc;
    }

    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #2d3748;
      border-bottom: 2px solid #e2e8f0;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      color: #4a5568;
    }

    tbody tr:hover {
      background: #f7fafc;
    }

    td a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }

    td a:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .recommended-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 0.9em;
      }

      th, td {
        padding: 8px;
      }
    }
  </style>
</BaseLayout>
